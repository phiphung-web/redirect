<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>System Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <%- include('../partials/header', { user, backUrl: '/redirect', breadcrumb: [{ label: 'System Status' }], active: 'system' }) %>
    <div class="container mt-3">
        <h3 class="mb-3">System Status</h3>
        <div class="row g-3 mb-4">
            <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Uptime (OS)</div><h5 class="fw-bold" id="uptimeOs"><%= Math.round(uptime/3600) %> h</h5></div></div></div>
            <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Uptime (App)</div><h5 class="fw-bold" id="uptimeApp"><%= Math.round(procUptime/3600) %> h</h5></div></div></div>
            <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">Load 1m</div><h5 class="fw-bold" id="load1"><%= load1.toFixed(2) %></h5></div></div></div>
            <div class="col-md-3"><div class="card shadow-sm"><div class="card-body"><div class="text-muted">DB</div><h5 class="fw-bold <%= dbStatus==='ok' ? 'text-success' : 'text-danger' %>" id="dbStatus"><%= dbStatus %></h5></div></div></div>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold">Memory & Process</div>
                    <div class="card-body">
                        <p>Tong: <span id="memTotal"><%= Math.round(memTotal/1024/1024) %></span> MB</p>
                        <p>Dang dung: <span id="memUsed"><%= Math.round(memUsed/1024/1024) %></span> MB</p>
                        <p>Con trong: <span id="memFree"><%= Math.round(memFree/1024/1024) %></span> MB</p>
                        <p class="mt-3">Process RSS: <span id="procRss"><%= Math.round(procMem.rss/1024/1024) %></span> MB</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white fw-bold">Server</div>
                    <div class="card-body">
                        <p>Platform: <span id="platform"><%= platform %> <%= release %></span></p>
                        <p>CPU: <span id="cpuModel"><%= cpuModel %></span> (<span id="cpuCores"><%= cpuCores %></span> cores)</p>
                        <p>Timezone: <span id="tz"><%= timezone %></span></p>
                        <p>Node: <span id="nodeVer"><%= nodeVersion %></span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-header bg-white fw-bold">Database</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p>DB Version: <span id="dbVersion"><%= (dbInfo && dbInfo.version) || '-' %></span></p>
                        <p>Ket noi: <span id="dbConn"><%= dbInfo?.connections || 0 %></span> (Active: <span id="dbActive"><%= dbInfo?.active_connections || 0 %></span>, Idle: <span id="dbIdle"><%= dbInfo?.idle_connections || 0 %></span>)</p>
                        <p>DB Size: <span id="dbSize"><%= dbInfo?.db_size ? Math.round(dbInfo.db_size/1024/1024) : 0 %></span> MB</p>
                        <p>Cache hit: <span id="dbCache"><%= dbInfo?.cache_hit || 'N/A' %></span>%</p>
                    </div>
                    <div class="col-md-6">
                        <p>max_connections: <span id="dbMaxConn"><%= dbInfo?.settings?.max_connections || '-' %></span></p>
                        <p>shared_buffers: <span id="dbShared"><%= dbInfo?.settings?.shared_buffers || '-' %></span></p>
                        <p>work_mem: <span id="dbWork"><%= dbInfo?.settings?.work_mem || '-' %></span></p>
                        <p>maintenance_work_mem: <span id="dbMaint"><%= dbInfo?.settings?.maintenance_work_mem || '-' %></span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-muted small">Tu dong cap nhat moi 10s.</div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        const fmtMB = (val) => Math.round(val / 1024 / 1024);
        const update = (data) => {
            document.getElementById('uptimeOs').innerText = Math.round(data.uptime/3600) + ' h';
            document.getElementById('uptimeApp').innerText = Math.round(data.procUptime/3600) + ' h';
            document.getElementById('load1').innerText = data.load1.toFixed(2);
            const dbNode = document.getElementById('dbStatus');
            dbNode.innerText = data.dbStatus;
            dbNode.className = 'fw-bold ' + (data.dbStatus==='ok' ? 'text-success' : 'text-danger');
            document.getElementById('memTotal').innerText = fmtMB(data.memTotal);
            document.getElementById('memUsed').innerText = fmtMB(data.memUsed);
            document.getElementById('memFree').innerText = fmtMB(data.memFree);
            document.getElementById('procRss').innerText = fmtMB(data.procMem.rss);
            document.getElementById('dbVersion').innerText = data.dbInfo?.version || '-';
            document.getElementById('dbConn').innerText = data.dbInfo?.connections || 0;
            document.getElementById('dbActive').innerText = data.dbInfo?.active_connections || 0;
            document.getElementById('dbIdle').innerText = data.dbInfo?.idle_connections || 0;
            document.getElementById('dbSize').innerText = data.dbInfo?.db_size ? fmtMB(data.dbInfo.db_size) : 0;
            document.getElementById('dbCache').innerText = data.dbInfo?.cache_hit ?? 'N/A';
            document.getElementById('dbMaxConn').innerText = data.dbInfo?.settings?.max_connections || '-';
            document.getElementById('dbShared').innerText = data.dbInfo?.settings?.shared_buffers || '-';
            document.getElementById('dbWork').innerText = data.dbInfo?.settings?.work_mem || '-';
            document.getElementById('dbMaint').innerText = data.dbInfo?.settings?.maintenance_work_mem || '-';
            document.getElementById('platform').innerText = (data.platform || '') + ' ' + (data.release || '');
            document.getElementById('cpuModel').innerText = data.cpuModel || '-';
            document.getElementById('cpuCores').innerText = data.cpuCores || '-';
            document.getElementById('tz').innerText = data.timezone || '-';
            document.getElementById('nodeVer').innerText = data.nodeVersion || '-';
        };
        async function refreshSystem() {
            try {
                const res = await fetch('/admin/system/data');
                if (!res.ok) return;
                const json = await res.json();
                update(json);
            } catch (e) {
                console.error('Refresh system error', e);
            }
        }
        setInterval(refreshSystem, 10000);
        refreshSystem();
    </script>
    <%- include('../partials/footer') %>
</body>
</html>
